{"version":3,"sources":["Query-compiled.js"],"names":[],"mappings":"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","file":"Query-compiled-compiled.js","sourcesContent":["var Sequence = require('./Sequence');\nvar Util = require('util');\nvar Packets = require('../packets');\nvar ResultSet = require('../ResultSet');\nvar ServerStatus = require('../constants/server_status');\nvar fs = require('fs');\nvar Readable = require('readable-stream');\n\nmodule.exports = Query;\nUtil.inherits(Query, Sequence);\nfunction Query(options, callback) {\n  Sequence.call(this, options, callback);\n\n  this.sql = options.sql;\n  this.values = options.values;\n  this.typeCast = options.typeCast === undefined ? true : options.typeCast;\n  this.nestTables = options.nestTables || false;\n\n  this._resultSet = null;\n  this._results = [];\n  this._fields = [];\n  this._index = 0;\n  this._loadError = null;\n}\n\nQuery.prototype.start = function () {\n  this.emit('packet', new Packets.ComQueryPacket(this.sql));\n};\n\nQuery.prototype.determinePacket = function determinePacket(byte, parser) {\n  var resultSet = this._resultSet;\n\n  if (!resultSet) {\n    switch (byte) {\n      case 0x00:\n        return Packets.OkPacket;\n      case 0xff:\n        return Packets.ErrorPacket;\n      default:\n        return Packets.ResultSetHeaderPacket;\n    }\n  }\n\n  if (resultSet.eofPackets.length === 0) {\n    return resultSet.fieldPackets.length < resultSet.resultSetHeaderPacket.fieldCount ? Packets.FieldPacket : Packets.EofPacket;\n  }\n\n  if (byte === 0xff) {\n    return Packets.ErrorPacket;\n  }\n\n  if (byte === 0xfe && parser.packetLength() < 9) {\n    return Packets.EofPacket;\n  }\n\n  return Packets.RowDataPacket;\n};\n\nQuery.prototype['OkPacket'] = function (packet) {\n  // try...finally for exception safety\n  try {\n    if (!this._callback) {\n      this.emit('result', packet, this._index);\n    } else {\n      this._results.push(packet);\n      this._fields.push(undefined);\n    }\n  } finally {\n    this._index++;\n    this._resultSet = null;\n    this._handleFinalResultPacket(packet);\n  }\n};\n\nQuery.prototype['ErrorPacket'] = function (packet) {\n  var err = this._packetToError(packet);\n\n  var results = this._results.length > 0 ? this._results : undefined;\n\n  var fields = this._fields.length > 0 ? this._fields : undefined;\n\n  err.index = this._index;\n  this.end(err, results, fields);\n};\n\nQuery.prototype['ResultSetHeaderPacket'] = function (packet) {\n  if (packet.fieldCount === null) {\n    this._sendLocalDataFile(packet.extra);\n  } else {\n    this._resultSet = new ResultSet(packet);\n  }\n};\n\nQuery.prototype['FieldPacket'] = function (packet) {\n  this._resultSet.fieldPackets.push(packet);\n};\n\nQuery.prototype['EofPacket'] = function (packet) {\n  this._resultSet.eofPackets.push(packet);\n\n  if (this._resultSet.eofPackets.length === 1 && !this._callback) {\n    this.emit('fields', this._resultSet.fieldPackets, this._index);\n  }\n\n  if (this._resultSet.eofPackets.length !== 2) {\n    return;\n  }\n\n  if (this._callback) {\n    this._results.push(this._resultSet.rows);\n    this._fields.push(this._resultSet.fieldPackets);\n  }\n\n  this._index++;\n  this._resultSet = null;\n  this._handleFinalResultPacket(packet);\n};\n\nQuery.prototype._handleFinalResultPacket = function (packet) {\n  if (packet.serverStatus & ServerStatus.SERVER_MORE_RESULTS_EXISTS) {\n    return;\n  }\n\n  var results = this._results.length > 1 ? this._results : this._results[0];\n\n  var fields = this._fields.length > 1 ? this._fields : this._fields[0];\n\n  this.end(this._loadError, results, fields);\n};\n\nQuery.prototype['RowDataPacket'] = function (packet, parser, connection) {\n  packet.parse(parser, this._resultSet.fieldPackets, this.typeCast, this.nestTables, connection);\n\n  if (this._callback) {\n    this._resultSet.rows.push(packet);\n  } else {\n    this.emit('result', packet, this._index);\n  }\n};\n\nQuery.prototype._sendLocalDataFile = function (path) {\n  var self = this;\n  var localStream = fs.createReadStream(path, {\n    flag: 'r',\n    encoding: null,\n    autoClose: true\n  });\n\n  this.on('pause', function () {\n    localStream.pause();\n  });\n\n  this.on('resume', function () {\n    localStream.resume();\n  });\n\n  localStream.on('data', function (data) {\n    self.emit('packet', new Packets.LocalDataFilePacket(data));\n  });\n\n  localStream.on('error', function (err) {\n    self._loadError = err;\n    localStream.emit('end');\n  });\n\n  localStream.on('end', function () {\n    self.emit('packet', new Packets.EmptyPacket());\n  });\n};\n\nQuery.prototype.stream = function (options) {\n  var self = this,\n      stream;\n\n  options = options || {};\n  options.objectMode = true;\n  stream = new Readable(options);\n\n  stream._read = function () {\n    self._connection && self._connection.resume();\n  };\n\n  stream.once('end', function () {\n    process.nextTick(function () {\n      stream.emit('close');\n    });\n  });\n\n  this.on('result', function (row, i) {\n    if (!stream.push(row)) self._connection.pause();\n    stream.emit('result', row, i); // replicate old emitter\n  });\n\n  this.on('error', function (err) {\n    stream.emit('error', err); // Pass on any errors\n  });\n\n  this.on('end', function () {\n    stream.push(null); // pushing null, indicating EOF\n  });\n\n  this.on('fields', function (fields, i) {\n    stream.emit('fields', fields, i); // replicate old emitter\n  });\n\n  return stream;\n};\n\n//# sourceMappingURL=Query-compiled.js.map"]}